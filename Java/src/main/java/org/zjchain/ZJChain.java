package org.zjchain;

import com.google.protobuf.ByteString;

import org.json.JSONObject;
import org.apache.http.HttpEntity;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.bouncycastle.util.encoders.Hex;
import org.web3j.abi.datatypes.Address;
import org.web3j.abi.datatypes.generated.Uint32;
import org.web3j.crypto.ECKeyPair;
import org.web3j.crypto.Hash;
import org.web3j.crypto.Sign;
import org.web3j.utils.Numeric;
import org.web3j.abi.*;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.math.BigInteger;
import java.net.URL;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.List;
import java.util.UUID;

import org.web3j.abi.datatypes.DynamicArray;
import org.web3j.abi.datatypes.DynamicBytes;
import org.web3j.abi.datatypes.Function;
import org.web3j.abi.datatypes.StaticStruct;
import org.web3j.abi.datatypes.Type;

import com.alibaba.fastjson.JSON;
import java.util.concurrent.ThreadLocalRandom;
import java.util.Random;
import java.util.Date;
import java.sql.Time;
import java.text.SimpleDateFormat;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.ChronoField;



/*
 * example:
 * 
 *      String privateKey = "b5039128131f96f6164a33bc7fbc48c2f5cf425e8476b1c4d0f4d186fbd0d708";
        ECKeyPair keyPair = ZJChain.GetKeyPair(privateKey);
        String dataId = "123";
        String data = "data";
        // 1. 发布
        Response res = ZJChain.CreateDataAuth(keyPair, dataId, data);

        Thread.sleep(3000);

        // 2. 确权
        Response res = ZJChain.DataAuth(keyPair, dataId, data);

        Thread.sleep(3000);

        // 3. 确权数据查询
        int limit = 100;
        int offset = 0;
        Response res = ZJChain.GetAuths(keyPair, dataId, limit, offset);
        System.out.println(res.getCode() + res.getContent());
 */


// ZJChain SDK
public class ZJChain {
    private static String contractCodes = "60806040526000805560405162002c5f38038062002c5f83398181016040528101906200002d919062000541565b60008351905060005b81811015620000ca576001600460008784815181106200005b576200005a620005fa565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080620000c19062000662565b91505062000036565b50600080819055506001600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600290816200017c9190620008f0565b506000825114620002645760405180608001604052808381526020013373ffffffffffffffffffffffffffffffffffffffff16815260200160005481526020014381525060036000805481526020019081526020016000206000820151816000019081620001eb9190620008f0565b5060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020155606082015181600301559050506000808154809291906200025e9062000662565b91905055505b50505050620009d7565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620002d28262000287565b810181811067ffffffffffffffff82111715620002f457620002f362000298565b5b80604052505050565b6000620003096200026e565b9050620003178282620002c7565b919050565b600067ffffffffffffffff8211156200033a576200033962000298565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200037d8262000350565b9050919050565b6200038f8162000370565b81146200039b57600080fd5b50565b600081519050620003af8162000384565b92915050565b6000620003cc620003c6846200031c565b620002fd565b90508083825260208201905060208402830185811115620003f257620003f16200034b565b5b835b818110156200041f57806200040a88826200039e565b845260208401935050602081019050620003f4565b5050509392505050565b600082601f83011262000441576200044062000282565b5b815162000453848260208601620003b5565b91505092915050565b600080fd5b600067ffffffffffffffff8211156200047f576200047e62000298565b5b6200048a8262000287565b9050602081019050919050565b60005b83811015620004b75780820151818401526020810190506200049a565b60008484015250505050565b6000620004da620004d48462000461565b620002fd565b905082815260208101848484011115620004f957620004f86200045c565b5b6200050684828562000497565b509392505050565b600082601f83011262000526576200052562000282565b5b815162000538848260208601620004c3565b91505092915050565b6000806000606084860312156200055d576200055c62000278565b5b600084015167ffffffffffffffff8111156200057e576200057d6200027d565b5b6200058c8682870162000429565b935050602084015167ffffffffffffffff811115620005b057620005af6200027d565b5b620005be868287016200050e565b925050604084015167ffffffffffffffff811115620005e257620005e16200027d565b5b620005f0868287016200050e565b9150509250925092565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000819050919050565b60006200066f8262000658565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203620006a457620006a362000629565b5b600182019050919050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200070257607f821691505b602082108103620007185762000717620006ba565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620007827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000743565b6200078e868362000743565b95508019841693508086168417925050509392505050565b6000819050919050565b6000620007d1620007cb620007c58462000658565b620007a6565b62000658565b9050919050565b6000819050919050565b620007ed83620007b0565b62000805620007fc82620007d8565b84845462000750565b825550505050565b600090565b6200081c6200080d565b62000829818484620007e2565b505050565b5b8181101562000851576200084560008262000812565b6001810190506200082f565b5050565b601f821115620008a0576200086a816200071e565b620008758462000733565b8101602085101562000885578190505b6200089d620008948562000733565b8301826200082e565b50505b505050565b600082821c905092915050565b6000620008c560001984600802620008a5565b1980831691505092915050565b6000620008e08383620008b2565b9150826002028217905092915050565b620008fb82620006af565b67ffffffffffffffff81111562000917576200091662000298565b5b620009238254620006e9565b6200093082828562000855565b600060209050601f83116001811462000968576000841562000953578287015190505b6200095f8582620008d2565b865550620009cf565b601f19841662000978866200071e565b60005b82811015620009a2578489015182556001820191506020850194506020810190506200097b565b86831015620009c25784890151620009be601f891682620008b2565b8355505b6001600288020188555050505b505050505050565b61227880620009e76000396000f3fe6080604052600436106100a75760003560e01c8063856ed09411610064578063856ed0941461021d5780638da5cb5b1461025a578063a257325a14610285578063e802a850146102c2578063e9073fc6146102eb578063f62aef3314610307576100a7565b806307937f1c146100ac5780630cdb0d53146100e9578063210d66f8146101265780632e559c0d14610166578063593b79fe146101a357806370587c10146101e0575b600080fd5b3480156100b857600080fd5b506100d360048036038101906100ce919061177a565b610330565b6040516100e09190611855565b60405180910390f35b3480156100f557600080fd5b50610110600480360381019061010b9190611877565b6106d3565b60405161011d9190611855565b60405180910390f35b34801561013257600080fd5b5061014d600480360381019061014891906118c0565b6108d9565b60405161015d949392919061190b565b60405180910390f35b34801561017257600080fd5b5061018d600480360381019061018891906118c0565b6109b1565b60405161019a9190611855565b60405180910390f35b3480156101af57600080fd5b506101ca60048036038101906101c59190611957565b610a0e565b6040516101d79190611855565b60405180910390f35b3480156101ec57600080fd5b5061020760048036038101906102029190611a6a565b610a37565b6040516102149190611855565b60405180910390f35b34801561022957600080fd5b50610244600480360381019061023f9190611957565b610bbf565b6040516102519190611ad5565b60405180910390f35b34801561026657600080fd5b5061026f610bdf565b60405161027c9190611af0565b60405180910390f35b34801561029157600080fd5b506102ac60048036038101906102a79190611b47565b610c05565b6040516102b99190611855565b60405180910390f35b3480156102ce57600080fd5b506102e960048036038101906102e49190611c4a565b611137565b005b61030560048036038101906103009190611877565b61122c565b005b34801561031357600080fd5b5061032e60048036038101906103299190611c4a565b61135d565b005b60606000606467ffffffffffffffff81111561034f5761034e6114e0565b5b60405190808252806020026020018201604052801561038257816020015b606081526020019060019003908161036d5790505b50905060006040518060400160405280600c81526020017f7b2261757468496e666f223a00000000000000000000000000000000000000008152508282806103c990611cc2565b9350815181106103dc576103db611d0a565b5b602002602001018190525084600001518282806103f890611cc2565b93508151811061040b5761040a611d0a565b5b60200260200101819052506040518060400160405280600b81526020017f2c22617574686f72223a2200000000000000000000000000000000000000000081525082828061045890611cc2565b93508151811061046b5761046a611d0a565b5b602002602001018190525061048b6104868660200151610a0e565b6106d3565b82828061049790611cc2565b9350815181106104aa576104a9611d0a565b5b60200260200101819052506040518060400160405280600881526020017f222c226964223a220000000000000000000000000000000000000000000000008152508282806104f790611cc2565b93508151811061050a57610509611d0a565b5b602002602001018190525061052a61052586604001516109b1565b6106d3565b82828061053690611cc2565b93508151811061054957610548611d0a565b5b60200260200101819052506040518060400160405280601181526020017f222c22626c6f636b4e756d626572223a2200000000000000000000000000000081525082828061059690611cc2565b9350815181106105a9576105a8611d0a565b5b60200260200101819052506105c96105c486606001516109b1565b6106d3565b8282806105d590611cc2565b9350815181106105e8576105e7611d0a565b5b6020026020010181905250831561065e576040518060400160405280600281526020017f227d00000000000000000000000000000000000000000000000000000000000081525082828061063b90611cc2565b93508151811061064e5761064d611d0a565b5b60200260200101819052506106bf565b6040518060400160405280600381526020017f227d2c00000000000000000000000000000000000000000000000000000000008152508282806106a090611cc2565b9350815181106106b3576106b2611d0a565b5b60200260200101819052505b6106c98282610a37565b9250505092915050565b60606000600283516106e59190611d39565b67ffffffffffffffff8111156106fe576106fd6114e0565b5b6040519080825280601f01601f1916602001820160405280156107305781602001600182028036833780820191505090505b50905060006040518060400160405280601081526020017f3031323334353637383961626364656600000000000000000000000000000000815250905060005b84518110156108ce5781825186838151811061078f5761078e611d0a565b5b602001015160f81c60f81b60f81c60ff166107aa9190611daa565b815181106107bb576107ba611d0a565b5b602001015160f81c60f81b836002836107d49190611d39565b815181106107e5576107e4611d0a565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535081825186838151811061082a57610829611d0a565b5b602001015160f81c60f81b60f81c60ff166108459190611ddb565b8151811061085657610855611d0a565b5b602001015160f81c60f81b8360016002846108719190611d39565b61087b9190611e0c565b8151811061088c5761088b611d0a565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806108c690611cc2565b915050610770565b508192505050919050565b60036020528060005260406000206000915090508060000180546108fc90611e6f565b80601f016020809104026020016040519081016040528092919081815260200182805461092890611e6f565b80156109755780601f1061094a57610100808354040283529160200191610975565b820191906000526020600020905b81548152906001019060200180831161095857829003601f168201915b5050505050908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020154908060030154905084565b6060602067ffffffffffffffff8111156109ce576109cd6114e0565b5b6040519080825280601f01601f191660200182016040528015610a005781602001600182028036833780820191505090505b509050816020820152919050565b606081604051602001610a219190611ee8565b6040516020818303038152906040529050919050565b60606000805b83811015610a8157848181518110610a5857610a57611d0a565b5b60200260200101515182610a6c9190611e0c565b91508080610a7990611cc2565b915050610a3d565b5060008167ffffffffffffffff811115610a9e57610a9d6114e0565b5b6040519080825280601f01601f191660200182016040528015610ad05781602001600182028036833780820191505090505b5090506000805b85811015610bb25760005b878281518110610af557610af4611d0a565b5b602002602001015151811015610b9e57878281518110610b1857610b17611d0a565b5b60200260200101518181518110610b3257610b31611d0a565b5b602001015160f81c60f81b848480610b4990611cc2565b955081518110610b5c57610b5b611d0a565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080610b9690611cc2565b915050610ae2565b508080610baa90611cc2565b915050610ad7565b5081935050505092915050565b60046020528060005260406000206000915054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60606000600883610c169190611f03565b63ffffffff1667ffffffffffffffff811115610c3557610c346114e0565b5b604051908082528060200260200182016040528015610c6857816020015b6060815260200190600190039081610c535790505b50905060006040518060400160405280600981526020017f7b2264617461223a5b0000000000000000000000000000000000000000000000815250828280610caf90611cc2565b935081518110610cc257610cc1611d0a565b5b602002602001018190525060008054905060008590508163ffffffff168787610ceb9190611f03565b63ffffffff161115610d06578682610d039190611f3b565b90505b60008763ffffffff1690505b8782610d1e9190611f03565b63ffffffff16811015610eaa57610e6d60036000838152602001908152602001600020604051806080016040529081600082018054610d5c90611e6f565b80601f0160208091040260200160405190810160405280929190818152602001828054610d8890611e6f565b8015610dd55780601f10610daa57610100808354040283529160200191610dd5565b820191906000526020600020905b815481529060010190602001808311610db857829003601f168201915b505050505081526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016002820154815260200160038201548152505060018a85610e569190611f03565b610e609190611f3b565b63ffffffff168314610330565b858580610e7990611cc2565b965081518110610e8c57610e8b611d0a565b5b60200260200101819052508080610ea290611cc2565b915050610d12565b506040518060400160405280600b81526020017f5d2c22746f74616c223a22000000000000000000000000000000000000000000815250848480610eed90611cc2565b955081518110610f0057610eff611d0a565b5b6020026020010181905250610f3382604051602001610f1f9190611fa9565b6040516020818303038152906040526106d3565b848480610f3f90611cc2565b955081518110610f5257610f51611d0a565b5b60200260200101819052506040518060400160405280600c81526020017f222c226f6666736574223a220000000000000000000000000000000000000000815250848480610f9f90611cc2565b955081518110610fb257610fb1611d0a565b5b6020026020010181905250610fe587604051602001610fd19190611fa9565b6040516020818303038152906040526106d3565b848480610ff190611cc2565b95508151811061100457611003611d0a565b5b60200260200101819052506040518060400160405280600b81526020017f222c226c696d6974223a2200000000000000000000000000000000000000000081525084848061105190611cc2565b95508151811061106457611063611d0a565b5b6020026020010181905250611097866040516020016110839190611fa9565b6040516020818303038152906040526106d3565b8484806110a390611cc2565b9550815181106110b6576110b5611d0a565b5b60200260200101819052506040518060400160405280600281526020017f227d00000000000000000000000000000000000000000000000000000000000081525084848061110390611cc2565b95508151811061111657611115611d0a565b5b602002602001018190525061112b8484610a37565b94505050505092915050565b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461119157600080fd5b60008151905060005b81811015611227576001600460008584815181106111bb576111ba611d0a565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550808061121f90611cc2565b91505061119a565b505050565b600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1661128257600080fd5b60405180608001604052808281526020013373ffffffffffffffffffffffffffffffffffffffff168152602001600054815260200143815250600360008054815260200190815260200160002060008201518160000190816112e49190612170565b5060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550604082015181600201556060820151816003015590505060008081548092919061135590611cc2565b919050555050565b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146113b757600080fd5b60008151905060005b818110156114b157600460008483815181106113df576113de611d0a565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161561149e576004600084838151811061144b5761144a611d0a565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff02191690555b80806114a990611cc2565b9150506113c0565b505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b611518826114cf565b810181811067ffffffffffffffff82111715611537576115366114e0565b5b80604052505050565b600061154a6114b6565b9050611556828261150f565b919050565b600080fd5b600080fd5b600080fd5b600067ffffffffffffffff821115611585576115846114e0565b5b61158e826114cf565b9050602081019050919050565b82818337600083830152505050565b60006115bd6115b88461156a565b611540565b9050828152602081018484840111156115d9576115d8611565565b5b6115e484828561159b565b509392505050565b600082601f83011261160157611600611560565b5b81356116118482602086016115aa565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006116458261161a565b9050919050565b6116558161163a565b811461166057600080fd5b50565b6000813590506116728161164c565b92915050565b6000819050919050565b61168b81611678565b811461169657600080fd5b50565b6000813590506116a881611682565b92915050565b6000608082840312156116c4576116c36114ca565b5b6116ce6080611540565b9050600082013567ffffffffffffffff8111156116ee576116ed61155b565b5b6116fa848285016115ec565b600083015250602061170e84828501611663565b602083015250604061172284828501611699565b604083015250606061173684828501611699565b60608301525092915050565b60008115159050919050565b61175781611742565b811461176257600080fd5b50565b6000813590506117748161174e565b92915050565b60008060408385031215611791576117906114c0565b5b600083013567ffffffffffffffff8111156117af576117ae6114c5565b5b6117bb858286016116ae565b92505060206117cc85828601611765565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b60005b838110156118105780820151818401526020810190506117f5565b60008484015250505050565b6000611827826117d6565b61183181856117e1565b93506118418185602086016117f2565b61184a816114cf565b840191505092915050565b6000602082019050818103600083015261186f818461181c565b905092915050565b60006020828403121561188d5761188c6114c0565b5b600082013567ffffffffffffffff8111156118ab576118aa6114c5565b5b6118b7848285016115ec565b91505092915050565b6000602082840312156118d6576118d56114c0565b5b60006118e484828501611699565b91505092915050565b6118f68161163a565b82525050565b61190581611678565b82525050565b60006080820190508181036000830152611925818761181c565b905061193460208301866118ed565b61194160408301856118fc565b61194e60608301846118fc565b95945050505050565b60006020828403121561196d5761196c6114c0565b5b600061197b84828501611663565b91505092915050565b600067ffffffffffffffff82111561199f5761199e6114e0565b5b602082029050602081019050919050565b600080fd5b60006119c86119c384611984565b611540565b905080838252602082019050602084028301858111156119eb576119ea6119b0565b5b835b81811015611a3257803567ffffffffffffffff811115611a1057611a0f611560565b5b808601611a1d89826115ec565b855260208501945050506020810190506119ed565b5050509392505050565b600082601f830112611a5157611a50611560565b5b8135611a618482602086016119b5565b91505092915050565b60008060408385031215611a8157611a806114c0565b5b600083013567ffffffffffffffff811115611a9f57611a9e6114c5565b5b611aab85828601611a3c565b9250506020611abc85828601611699565b9150509250929050565b611acf81611742565b82525050565b6000602082019050611aea6000830184611ac6565b92915050565b6000602082019050611b0560008301846118ed565b92915050565b600063ffffffff82169050919050565b611b2481611b0b565b8114611b2f57600080fd5b50565b600081359050611b4181611b1b565b92915050565b60008060408385031215611b5e57611b5d6114c0565b5b6000611b6c85828601611b32565b9250506020611b7d85828601611b32565b9150509250929050565b600067ffffffffffffffff821115611ba257611ba16114e0565b5b602082029050602081019050919050565b6000611bc6611bc184611b87565b611540565b90508083825260208201905060208402830185811115611be957611be86119b0565b5b835b81811015611c125780611bfe8882611663565b845260208401935050602081019050611beb565b5050509392505050565b600082601f830112611c3157611c30611560565b5b8135611c41848260208601611bb3565b91505092915050565b600060208284031215611c6057611c5f6114c0565b5b600082013567ffffffffffffffff811115611c7e57611c7d6114c5565b5b611c8a84828501611c1c565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000611ccd82611678565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611cff57611cfe611c93565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000611d4482611678565b9150611d4f83611678565b9250828202611d5d81611678565b91508282048414831517611d7457611d73611c93565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000611db582611678565b9150611dc083611678565b925082611dd057611dcf611d7b565b5b828204905092915050565b6000611de682611678565b9150611df183611678565b925082611e0157611e00611d7b565b5b828206905092915050565b6000611e1782611678565b9150611e2283611678565b9250828201905080821115611e3a57611e39611c93565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680611e8757607f821691505b602082108103611e9a57611e99611e40565b5b50919050565b60008160601b9050919050565b6000611eb882611ea0565b9050919050565b6000611eca82611ead565b9050919050565b611ee2611edd8261163a565b611ebf565b82525050565b6000611ef48284611ed1565b60148201915081905092915050565b6000611f0e82611b0b565b9150611f1983611b0b565b9250828201905063ffffffff811115611f3557611f34611c93565b5b92915050565b6000611f4682611b0b565b9150611f5183611b0b565b9250828203905063ffffffff811115611f6d57611f6c611c93565b5b92915050565b60008160e01b9050919050565b6000611f8b82611f73565b9050919050565b611fa3611f9e82611b0b565b611f80565b82525050565b6000611fb58284611f92565b60048201915081905092915050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026120267fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611fe9565b6120308683611fe9565b95508019841693508086168417925050509392505050565b6000819050919050565b600061206d61206861206384611678565b612048565b611678565b9050919050565b6000819050919050565b61208783612052565b61209b61209382612074565b848454611ff6565b825550505050565b600090565b6120b06120a3565b6120bb81848461207e565b505050565b5b818110156120df576120d46000826120a8565b6001810190506120c1565b5050565b601f821115612124576120f581611fc4565b6120fe84611fd9565b8101602085101561210d578190505b61212161211985611fd9565b8301826120c0565b50505b505050565b600082821c905092915050565b600061214760001984600802612129565b1980831691505092915050565b60006121608383612136565b9150826002028217905092915050565b612179826117d6565b67ffffffffffffffff811115612192576121916114e0565b5b61219c8254611e6f565b6121a78282856120e3565b600060209050601f8311600181146121da57600084156121c8578287015190505b6121d28582612154565b86555061223a565b601f1984166121e886611fc4565b60005b82811015612210578489015182556001820191506020850194506020810190506121eb565b8683101561222d5784890151612229601f891682612136565b8355505b6001600288020188555050505b50505050505056fea26469706673582212202687927142d39a9a50c97bc5153a147ea3721d89bc05fb1559c114707511fc2464736f6c63430008110033";
    private static String managerAddr = "0xe252D01A37b85E2007Ed3CC13797aa92496204A4";
    // private static String baseUrl = "http://82.156.224.174:8080";
    private static String baseUrl = "http://44.216.214.237:8000";
    private static int target_sharding_id = 3;

    public enum ActionType
    {
        PUBLISH, // 发布
        VIEW, // 查看
        DOWNLOAD, // 下载
        COLLECT, // 收藏
        TO_MYDDE, // MYDDE 上使用
        TO_EARTH, // ee 上查看
    }


    public static void main(String[] args) {
        // String privateKey = "fa04ebee157c6c10bd9d250fc2c938780bf68cbe30e9f0d7c048e4d081907971";
        String privateKey = "b5039128131f96f6164a33bc7fbc48c2f5cf425e8476b1c4d0f4d186fbd0d708";

        ZJChain.SetBaseUrl("http://10.101.20.35:8785");
        KeyPair keyPair = ZJChain.GetKeyPair(privateKey);
        String dataId = "21";

        Response res = ZJChain.GetAuths(keyPair, dataId, 10, 0);
        System.out.println(res.getCode() + res.getContent());

        // mockDatas(keyPair);

        tryCreate(keyPair, dataId);
    }

    private static void mockDatas(KeyPair keyPair) {
        ArrayList<String> dataIds = new ArrayList<>();
        // dataIds.add("17F5B85CAFC21000");
        dataIds.add("17F5B7CADE821000");
        dataIds.add("17F5B75F46421000");
        dataIds.add("1808DAA378C21000");
        dataIds.add("1808DCA90E421000");
        dataIds.add("1808DCD50F421000");
        dataIds.add("1808DD547F821000");
        dataIds.add("1808DD8EFEC21000");
        dataIds.add("1808DEA031421000");
        dataIds.add("1808DF027E821000");
        
        String actionTime = "2023-12-07 15:00:00";

        for (int i = 0; i < dataIds.size(); i++) {
            String dataId = dataIds.get(i);
            int logNum = randomNum(5, 20);
            for (int j = 0; j < logNum; j++) {
                actionTime = randomTimeStr(actionTime);
                System.out.println(actionTime);
                AddDataAuth(keyPair, dataId, randomPostData(actionTime));
                try {
                    Thread.sleep(1000);
                } catch (Exception e) {};   
            }
     
        }
    }

    private static String randomPostData(String actionTime) {
        String tmp = "{\"action_type\": %d, \"data\": \"\", \"action_user\": \"admin\", \"action_time\": \"%s\"}";
        String postData = String.format(tmp, randomNum(1, 5), actionTime);

        return postData;
    }

    private static String randomTimeStr(String after) {
        String newTime = "";
        try {
            SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            Date d = df.parse(after); 
            Calendar cal = Calendar.getInstance();
            cal.setTime(d);
            cal.add(Calendar.HOUR, randomNum(0, 1));
            cal.add(Calendar.MINUTE, randomNum(0, 60));
            cal.add(Calendar.SECOND, randomNum(0, 60));
            newTime = df.format(cal.getTime());
            
        } catch (Exception e) {

        }
        return newTime;
    }

    private static int randomNum(int min, int max) {
        return ThreadLocalRandom.current().nextInt(min, max + 1);
    }

    private static void tryCreate(KeyPair keyPair, String dataId) {
        String data = "{\"action_type\": 0, \"action_user\": \"admin\", \"action_time\": \"2023-12-05 17:30:00\", \"data\": {\n" + //
                "  \"baseInfo\": {\n" + //
                "    \"dataAddress\": \"17F5B85CAFC21000\",\n" + //
                "    \"status\": 1,\n" + //
                "    \"type\": \"map\",\n" + //
                "    \"authorizationType\": \"Public\",\n" + //
                "    \"baseInfoStatus\": 1,\n" + //
                "    \"name\": \"Detrital zircon - Map\",\n" + //
                "    \"version\": \"1.0\",\n" + //
                "    \"description\": \"Detrital zircons provide one of the biggest data in geoscience research. Improvements in analytical technique and data processing lead to a large deposit of detrital zircon geochronology and geochemical-isotopic data in published journal articles, thesis, and reports. Under the support of Deep-time Digital Earth Big Science Program, OneSediment Project conducted a team-working effort to assemble the detrital zircon data for mainland China and adjacent regions (middle East, Turkey, Cyprus and Greek peninsula). Entity-Relationship diagram was constructed for detrital zircon data to determine what information need to be collected. Researchers and students from 13 institutions were organized together to fulfill this task and generated 13 detrital zircon datasets. The assembled datasets totally include 6,635 samples and 56,0596 analyses. They can be used to track crustal growth, tectonic evolution, provenance analysis and paleogeographic change in regional and, when combined with other detrital zircon dataset, global scales.\",\n" + //
                "    \"subjectIds\": \"25\",\n" + //
                "    \"subjects\": [\n" + //
                "      {\n" + //
                "        \"id\": 25,\n" + //
                "        \"level\": 2,\n" + //
                "        \"parent\": 15,\n" + //
                "        \"name\": \"Sedimentology\",\n" + //
                "        \"icon\": \"\",\n" + //
                "        \"description\": \"\",\n" + //
                "        \"count\": null\n" + //
                "      }\n" + //
                "    ],\n" + //
                "    \"tagIds\": null,\n" + //
                "    \"tags\": null,\n" + //
                "    \"dataNodeIds\": null,\n" + //
                "    \"dataNodeIdList\": null,\n" + //
                "    \"dataNodes\": null,\n" + //
                "    \"credence\": \"Official\",\n" + //
                "    \"browseGraph\": \"\",\n" + //
                "    \"license\": null,\n" + //
                "    \"intellectualProp\": null,\n" + //
                "    \"discipline\": null,\n" + //
                "    \"source\": null,\n" + //
                "    \"authorName\": null,\n" + //
                "    \"authorMail\": null,\n" + //
                "    \"associatedResource\": \"INNER##Detrital zircon - Database\",\n" + //
                "    \"associatedResourceUrl\": \"17F5B9A20E421000\",\n" + //
                "    \"intellectualGraph\": \"<p></p>\",\n" + //
                "    \"spatialInfoStatus\": 1,\n" + //
                "    \"minX\": \"-180\",\n" + //
                "    \"minY\": \"-90\",\n" + //
                "    \"maxX\": \"180\",\n" + //
                "    \"maxY\": \"90\",\n" + //
                "    \"resolution\": null,\n" + //
                "    \"coordinateReferenceSystem\": null,\n" + //
                "    \"elevation\": \"0\",\n" + //
                "    \"temporalInfoStatus\": 0,\n" + //
                "    \"geologicTime\": null,\n" + //
                "    \"geologicAge\": null,\n" + //
                "    \"geologicalBase\": null,\n" + //
                "    \"geologicalTop\": null,\n" + //
                "    \"gtsVersion\": null,\n" + //
                "    \"requestUrl\": \"https://carto.deep-time.org/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\",\n" + //
                "    \"dataSource\": 1,\n" + //
                "    \"extend1\": null,\n" + //
                "    \"extend2\": null\n" + //
                "  },\n" + //
                "  \"register\": {\n" + //
                "    \"type\": \"map\",\n" + //
                "    \"connectorType\": null,\n" + //
                "    \"connectorName\": null,\n" + //
                "    \"connectorDescription\": null,\n" + //
                "    \"connectInfoDatabase\": [],\n" + //
                "    \"tableName\": null,\n" + //
                "    \"endpoint\": \"carto.deep-time.org\",\n" + //
                "    \"tls\": \"Yes\",\n" + //
                "    \"description\": null,\n" + //
                "    \"serviceType\": null,\n" + //
                "    \"path\": \"/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\",\n" + //
                "    \"gisProtocol\": \"OGC\",\n" + //
                "    \"mapProtocol\": \"TMS\",\n" + //
                "    \"mapThumbnail\": null,\n" + //
                "    \"mapHeaders\": \"{}\",\n" + //
                "    \"mapQueryParameters\": \"{}\",\n" + //
                "    \"mapOtherParameters\": \"{\\\"version\\\":\\\"TMS 1.0.0\\\",\\\"layer\\\":\\\"tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe\\\"}\",\n" + //
                "    \"linkType\": null,\n" + //
                "    \"doi\": null,\n" + //
                "    \"fileSize\": null,\n" + //
                "    \"records\": null,\n" + //
                "    \"fileType\": null,\n" + //
                "    \"subDataType\": null,\n" + //
                "    \"storageType\": null,\n" + //
                "    \"connectInfoStorage\": [],\n" + //
                "    \"storageFilePath\": null,\n" + //
                "    \"url\": \"carto.deep-time.org/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\"\n" + //
                "  },\n" + //
                "  \"apiDefine\": null,\n" + //
                "  \"tableColumnList\": null\n" + //
                "}}";


        ZJChain.CreateDataAuth(keyPair, dataId, data);
        
        try {
            Thread.sleep(1000);
        } catch (Exception e) {

        }
        data = "{\"type\": 1, \"data\": \"自建\"}";
        
        ZJChain.AddDataAuth(keyPair, dataId, data);

        data = "{\"action_type\": 0, \"action_user\": \"new admin\", \"action_time\": \"2023-12-05 17:30:00\", \"data\": {\n" + //
                "  \"baseInfo\": {\n" + //
                "    \"dataAddress\": \"17F5B85CAFC21000\",\n" + //
                "    \"status\": 1,\n" + //
                "    \"type\": \"map\",\n" + //
                "    \"authorizationType\": \"Public\",\n" + //
                "    \"baseInfoStatus\": 1,\n" + //
                "    \"name\": \"Detrital zircon - Map\",\n" + //
                "    \"version\": \"1.0\",\n" + //
                "    \"description\": \"Detrital zircons provide one of the biggest data in geoscience research. Improvements in analytical technique and data processing lead to a large deposit of detrital zircon geochronology and geochemical-isotopic data in published journal articles, thesis, and reports. Under the support of Deep-time Digital Earth Big Science Program, OneSediment Project conducted a team-working effort to assemble the detrital zircon data for mainland China and adjacent regions (middle East, Turkey, Cyprus and Greek peninsula). Entity-Relationship diagram was constructed for detrital zircon data to determine what information need to be collected. Researchers and students from 13 institutions were organized together to fulfill this task and generated 13 detrital zircon datasets. The assembled datasets totally include 6,635 samples and 56,0596 analyses. They can be used to track crustal growth, tectonic evolution, provenance analysis and paleogeographic change in regional and, when combined with other detrital zircon dataset, global scales.\",\n" + //
                "    \"subjectIds\": \"25\",\n" + //
                "    \"subjects\": [\n" + //
                "      {\n" + //
                "        \"id\": 25,\n" + //
                "        \"level\": 2,\n" + //
                "        \"parent\": 15,\n" + //
                "        \"name\": \"Sedimentology\",\n" + //
                "        \"icon\": \"\",\n" + //
                "        \"description\": \"\",\n" + //
                "        \"count\": null\n" + //
                "      }\n" + //
                "    ],\n" + //
                "    \"tagIds\": null,\n" + //
                "    \"tags\": null,\n" + //
                "    \"dataNodeIds\": null,\n" + //
                "    \"dataNodeIdList\": null,\n" + //
                "    \"dataNodes\": null,\n" + //
                "    \"credence\": \"Official\",\n" + //
                "    \"browseGraph\": \"\",\n" + //
                "    \"license\": null,\n" + //
                "    \"intellectualProp\": null,\n" + //
                "    \"discipline\": null,\n" + //
                "    \"source\": null,\n" + //
                "    \"authorName\": null,\n" + //
                "    \"authorMail\": null,\n" + //
                "    \"associatedResource\": \"INNER##Detrital zircon - Database\",\n" + //
                "    \"associatedResourceUrl\": \"17F5B9A20E421000\",\n" + //
                "    \"intellectualGraph\": \"<p></p>\",\n" + //
                "    \"spatialInfoStatus\": 1,\n" + //
                "    \"minX\": \"-180\",\n" + //
                "    \"minY\": \"-90\",\n" + //
                "    \"maxX\": \"180\",\n" + //
                "    \"maxY\": \"90\",\n" + //
                "    \"resolution\": null,\n" + //
                "    \"coordinateReferenceSystem\": null,\n" + //
                "    \"elevation\": \"0\",\n" + //
                "    \"temporalInfoStatus\": 0,\n" + //
                "    \"geologicTime\": null,\n" + //
                "    \"geologicAge\": null,\n" + //
                "    \"geologicalBase\": null,\n" + //
                "    \"geologicalTop\": null,\n" + //
                "    \"gtsVersion\": null,\n" + //
                "    \"requestUrl\": \"https://carto.deep-time.org/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\",\n" + //
                "    \"dataSource\": 1,\n" + //
                "    \"extend1\": null,\n" + //
                "    \"extend2\": null\n" + //
                "  },\n" + //
                "  \"register\": {\n" + //
                "    \"type\": \"map\",\n" + //
                "    \"connectorType\": null,\n" + //
                "    \"connectorName\": null,\n" + //
                "    \"connectorDescription\": null,\n" + //
                "    \"connectInfoDatabase\": [],\n" + //
                "    \"tableName\": null,\n" + //
                "    \"endpoint\": \"carto.deep-time.org\",\n" + //
                "    \"tls\": \"Yes\",\n" + //
                "    \"description\": null,\n" + //
                "    \"serviceType\": null,\n" + //
                "    \"path\": \"/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\",\n" + //
                "    \"gisProtocol\": \"OGC\",\n" + //
                "    \"mapProtocol\": \"TMS\",\n" + //
                "    \"mapThumbnail\": null,\n" + //
                "    \"mapHeaders\": \"{}\",\n" + //
                "    \"mapQueryParameters\": \"{}\",\n" + //
                "    \"mapOtherParameters\": \"{\\\"version\\\":\\\"TMS 1.0.0\\\",\\\"layer\\\":\\\"tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe\\\"}\",\n" + //
                "    \"linkType\": null,\n" + //
                "    \"doi\": null,\n" + //
                "    \"fileSize\": null,\n" + //
                "    \"records\": null,\n" + //
                "    \"fileType\": null,\n" + //
                "    \"subDataType\": null,\n" + //
                "    \"storageType\": null,\n" + //
                "    \"connectInfoStorage\": [],\n" + //
                "    \"storageFilePath\": null,\n" + //
                "    \"url\": \"carto.deep-time.org/user/wuchaowei/api/v1/map/named/tpl_3f47acbd_b633_454d_bef4_a8693ef96ffe/mapnik/{z}/{x}/{y}.png\"\n" + //
                "  },\n" + //
                "  \"apiDefine\": null,\n" + //
                "  \"tableColumnList\": null\n" + //
                "}}";        
        ZJChain.ReCreateDataAuth(keyPair, dataId, data);
    }

    public static void SetBaseUrl(String base) {
        baseUrl = base;
    }

    public static String GetBaseUrl() {
        return baseUrl;
    }

    // GetKeyPair 根据私钥获取密钥对
    public static KeyPair GetKeyPair(String privateKeyStr) {
    	BigInteger privKey = new BigInteger(privateKeyStr, 16);
        BigInteger pubKey = Sign.publicKeyFromPrivate(privKey);
        ECKeyPair keyPair = new ECKeyPair(privKey, pubKey);
        return new KeyPair(keyPair.getPrivateKey(), keyPair.getPublicKey());
    }

    // GetAccountId 根据密钥对获取 AccountId
    public static String GetAccountId(KeyPair keyPair) {
        byte[] pk_arr = keyPair.getPublicKey().toByteArray();
        String accountId = "";
        if (pk_arr.length > 64) {
            byte[] slice = Arrays.copyOfRange(keyPair.getPublicKey().toByteArray(), 1, 65);
            byte[] addHex = Arrays.copyOfRange(Hash.sha3(slice), 12, 32);
            accountId = Hex.toHexString(addHex);
        } else {
            byte[] slice = Arrays.copyOfRange(keyPair.getPublicKey().toByteArray(), 0, 64);
            byte[] addHex = Arrays.copyOfRange(Hash.sha3(slice), 12, 32);
            accountId = Hex.toHexString(addHex);
        }
        return accountId;
    }

    // CreateDataAuth 发布
    public static Response CreateDataAuth(KeyPair keyPair, String dataId, String data) {
        JSONObject postData = GenCreateDataAuthParams(keyPair, dataId, data);
        return CallTransaction(postData);
    }

    // GenCreateDataAuthParams 获取首次确权参数
    private static JSONObject GenCreateDataAuthParams(KeyPair keyPair, String dataId, String data) {
        data = JSON.toJSONString(data);
		List<Address> addresses = new ArrayList<>();
        addresses.add(new Address(managerAddr));
        
        List<Type> inputParameters = Arrays.asList(
            new DynamicArray(StaticStruct.class, addresses), 
            new DynamicBytes(dataId.getBytes(StandardCharsets.UTF_8)), 
            new DynamicBytes(data.getBytes(StandardCharsets.UTF_8)));

        String input = FunctionEncoder.encodeConstructor(inputParameters);
        String create_data_str = contractCodes + input;

        byte[] pk_arr = keyPair.getPublicKey().toByteArray();
        String accountId = "";
        if (pk_arr.length > 64) {
            byte[] slice = Arrays.copyOfRange(keyPair.getPublicKey().toByteArray(), 1, 65);
            byte[] addHex = Arrays.copyOfRange(Hash.sha3(slice), 12, 32);
            accountId = Hex.toHexString(addHex);
        } else {
            byte[] slice = Arrays.copyOfRange(keyPair.getPublicKey().toByteArray(), 0, 64);
            byte[] addHex = Arrays.copyOfRange(Hash.sha3(slice), 12, 32);
            accountId = Hex.toHexString(addHex);
        }
        
        String gid = GenGid(getRandomString());
        String contract_addr_str = accountId + dataId + contractCodes;
        String kechash = Hex.toHexString(Hash.sha3(contract_addr_str.getBytes()));
        String self_contract_address = kechash.substring(kechash.length() - 40, kechash.length());

        JSONObject post_data = DoTransaction(keyPair, gid, self_contract_address, 0, 100000000000l, create_data_str, "", 6);
        post_data.put("data_id", dataId);
        return post_data;
    }


    private static String GetContractAddress(String dataId, String accountId) {
        String contract_addr_str = accountId + dataId + contractCodes;
        String kechash = Hex.toHexString(Hash.sha3(contract_addr_str.getBytes()));
        return kechash.substring(kechash.length() - 40, kechash.length());
    }

    // DataAuth 确权上链
    public static Response AddDataAuth(KeyPair keyPair, String dataId, String data) {
        JSONObject postData = GenDataAuthParams(keyPair, dataId, data);
        return CallTransaction(postData);
    }

    // GenDataAuthParams 获取数据存证参数
    private static JSONObject GenDataAuthParams(KeyPair keyPair, String dataId, String data) {
        // data = "{\"type\":\"add\", \"data\":" + data + "}";
        data = JSON.toJSONString(data);
        String accountId = GetAccountId(keyPair);
        String to = GetContractAddress(dataId, accountId);
    	String methodName = "Authorization";
        List<Type> inputParameters = new ArrayList<>();
        inputParameters.add(new DynamicBytes(data.getBytes(StandardCharsets.UTF_8)));
        List<TypeReference<?>> outputParameters = new ArrayList<>();
        Function function = new Function(methodName, inputParameters, outputParameters);
        String input = FunctionEncoder.encode(function).substring(2);
        JSONObject post_data = DoTransaction(keyPair, "", to, 0, 0, "", input, 8);
        post_data.put("data_id", dataId);
        return post_data;
    }

    public static Response ReCreateDataAuth(KeyPair keyPair, String dataId, String data) {
        JSONObject postData = GenReCreateDataAuthParams(keyPair, dataId, data);
        return CallTransaction(postData);
    }

    // GenReCreateDataAuthParams 更新发布数据
    private static JSONObject GenReCreateDataAuthParams(KeyPair keyPair, String dataId, String data) {
        data = JSON.toJSONString(data);
        String accountId = GetAccountId(keyPair);
        String to = GetContractAddress(dataId, accountId);
    	String methodName = "Authorization";
        List<Type> inputParameters = new ArrayList<>();
        inputParameters.add(new DynamicBytes(data.getBytes(StandardCharsets.UTF_8)));
        List<TypeReference<?>> outputParameters = new ArrayList<>();
        Function function = new Function(methodName, inputParameters, outputParameters);
        String input = FunctionEncoder.encode(function).substring(2);
        JSONObject post_data = DoTransaction(keyPair, "", to, 0, 0, "", input, 8);
        post_data.put("data_id", dataId);
        post_data.put("republish", 1);
        return post_data;
    }

    // GetAuths 批量查询确权数据
    public static Response GetAuths(KeyPair keyPair, String dataId, int limit, int offset) {
        JSONObject postData = GenGetAuthsParams(keyPair, dataId, limit, offset);
        return QueryContract(postData);
    }

    // GenGetAuthsParams 生成获取确权列表参数
    private static JSONObject GenGetAuthsParams(KeyPair keyPair, String dataId, int limit, int offset) {
        String from = GetAccountId(keyPair);
        String to = GetContractAddress(dataId, from);

    	JSONObject post_data = new JSONObject();
    	String methodName = "GetAuthJson";
        List<Type> inputParameters = new ArrayList<>();
        inputParameters.add(new Uint32(offset));
        inputParameters.add(new Uint32(limit));

        List<TypeReference<?>> outputParameters = new ArrayList<>();
        Function function = new Function(methodName, inputParameters, outputParameters);
        String input = FunctionEncoder.encode(function);
    	post_data.put("input", input.substring(2));
    	post_data.put("address", to);
    	post_data.put("from", from);

        post_data.put("data_id", dataId);
        return post_data;
    }
    
    
    private static String GenGid(String randStr) {
        try{
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(randStr.getBytes("UTF-8"));
            StringBuffer hexString = new StringBuffer();

            for (int i = 0; i < hash.length; i++) {
                String hex = Integer.toHexString(0xff & hash[i]);
                if(hex.length() == 1) hexString.append('0');
                hexString.append(hex);
            }

            return hexString.toString();
        } catch(Exception ex){
            throw new RuntimeException(ex);
        }
    }

    private static String getRandomString() {
        StringBuffer s = new StringBuffer();
        UUID uuid = UUID.randomUUID();
        s.append(uuid.toString().replace("-", ""));

        return s.toString();
    }

    private static byte[] longToBytes(long x) {
        ByteBuffer buffer = ByteBuffer.allocate(Long.BYTES);
        buffer.putLong(x);
        return buffer.array();
    }

    private static byte[] changeBytes(byte[] a){
        byte[] b = new byte[a.length];
        for (int i = 0; i < b.length; i++) {
            b[i] = a[b.length - i - 1];
        }
        return b;
    }
    
    private static JSONObject DoTransaction(
    		KeyPair keyPair,
    		String gid,
    		String to,
    		long amount,
    		long prepay,
    		String contract_bytes,
    		String input,
    		long step) {
    	BigInteger pubKey = keyPair.getPublicKey();
    	JSONObject jsonObject = new JSONObject();
    	if (gid.isEmpty()) {
    		gid = GenGid(getRandomString());
    	}
    	
    	byte[] gid_bytes = ByteString.copyFrom(Hex.decode(gid)).toByteArray();
    	jsonObject.put("gid", gid);
    	
    	long gas_limit = 100000000;
        byte[] pk_arr = pubKey.toByteArray();
        if (pk_arr.length <= 64) {
            byte[] tmp_pk_arr = new byte [1 + pk_arr.length];
            System.arraycopy(pk_arr, 0, tmp_pk_arr, 1, pk_arr.length);
            pk_arr = tmp_pk_arr;
        }
        pk_arr[0] = 4;
        jsonObject.put("pubkey", Hex.toHexString(pk_arr));
        System.out.println("pubkey: " + Hex.toHexString(pk_arr));
        jsonObject.put("to", to);
        jsonObject.put("type", step);
        jsonObject.put("amount", amount);
        jsonObject.put("gas_limit", gas_limit);
        jsonObject.put("gas_price", 1);
        jsonObject.put("shard_id", target_sharding_id);
       
        byte[] to_bytes = ByteString.copyFrom(Hex.decode(to)).toByteArray();
        ByteArrayOutputStream hash_stream = new ByteArrayOutputStream();
        hash_stream.write(gid_bytes,0,gid_bytes.length);
        hash_stream.write(pk_arr,0,pk_arr.length);
        hash_stream.write(to_bytes,0,to_bytes.length);        
        byte[] tmp_amount = changeBytes(longToBytes(amount));
        hash_stream.write(tmp_amount,0, tmp_amount.length);
        byte[] gas_limit_bytes = changeBytes(longToBytes(gas_limit));
        hash_stream.write(gas_limit_bytes,0, gas_limit_bytes.length);
        byte[] gas_price = changeBytes(longToBytes(1));
        hash_stream.write(gas_price,0, gas_price.length);
        byte[] bytes_step = changeBytes(longToBytes(step));
        hash_stream.write(bytes_step,0, bytes_step.length);
        
        if (!contract_bytes.isEmpty()) {
        	jsonObject.put("bytes_code", contract_bytes);
        	byte[] input_bytes = ByteString.copyFrom(Hex.decode(contract_bytes)).toByteArray();
            hash_stream.write(input_bytes,0,input_bytes.length);
        }
        
        if (!input.isEmpty()) {
        	jsonObject.put("input", input);
        	byte[] input_bytes = ByteString.copyFrom(Hex.decode(input)).toByteArray();
            hash_stream.write(input_bytes,0,input_bytes.length);
        }

        if (prepay > 0) {
            jsonObject.put("pepay", prepay);
            byte[] tmp_p = changeBytes(longToBytes(prepay));
            hash_stream.write(tmp_p,0, tmp_p.length);
        }

        byte[] tx_hash = Hash.sha3(hash_stream.toByteArray());

        System.out.println("tx_hash: " + Hex.toHexString(tx_hash));
        Sign.SignatureData sign = Sign.signMessage(tx_hash, new ECKeyPair(keyPair.getPrivateKey(), keyPair.getPublicKey()), false);
        jsonObject.put("sign_r", Hex.toHexString(sign.getR()));
        jsonObject.put("sign_s", Hex.toHexString(sign.getS()));
        BigInteger v = Numeric.toBigInt(sign.getV());
        jsonObject.put("sign_v", v.intValue() - 27);
        
        return jsonObject;
    }

    private static Response CallTransaction(JSONObject jsonInputString) {
    	return PostData(GetBaseUrl() + "/transaction", jsonInputString);
    }
    
    private static Response QueryContract(JSONObject jsonInputString) {
    	return PostData(GetBaseUrl() + "/query_contract", jsonInputString);
    }

    private static Response PostData(String path, JSONObject jsonInputString) {
		try {
			URL url = new URL(path);
			CloseableHttpClient client = HttpClients.createDefault();
	        HttpPost httpPost=new HttpPost(path);
	        List<BasicNameValuePair> list=new ArrayList<>();
	        for(String str:jsonInputString.keySet()){
	        	list.add(new BasicNameValuePair(str,jsonInputString.get(str).toString()));
	        }
	       
	        StringEntity stringEntity=new UrlEncodedFormEntity(list,"utf-8");
	        httpPost.setEntity(stringEntity);
	        CloseableHttpResponse execute = client.execute(httpPost);
	        int code = execute.getStatusLine().getStatusCode();

	        HttpEntity entity = execute.getEntity();
	        String content = EntityUtils.toString(entity, "utf-8");

	        client.close();
            return new Response(code, content);
		} catch (IOException e) {
			e.printStackTrace();
            return new Response(-1, e.toString());
		}
    }
}


